"use strict";var Promise=require("bluebird"),xml2js=require("xml2js"),parseString=Promise.promisify(xml2js.parseString),builder=new xml2js.Builder,_=require("underscore");require("./underscore_mixin");var config=require("./Config"),Excel=require("jszip");_.extend(Excel.prototype,{sharedStrings:function(){return this.file(config.EXCEL_FILES.FILE_SHARED_STRINGS).asText()},parseSharedStrings:function(){return this.parseFile(config.EXCEL_FILES.FILE_SHARED_STRINGS)},setSharedStrings:function(e){return e&&this.file(config.EXCEL_FILES.FILE_SHARED_STRINGS,builder.buildObject(e)),this},parseWorkbookRels:function(){return this.parseFile(config.EXCEL_FILES.FILE_WORKBOOK_RELS)},setWorkbookRels:function(e){return this.file(config.EXCEL_FILES.FILE_WORKBOOK_RELS,builder.buildObject(e)),this},parseWorkbook:function(){return this.parseFile(config.EXCEL_FILES.FILE_WORKBOOK)},setWorkbook:function(e){return this.file(config.EXCEL_FILES.FILE_WORKBOOK,builder.buildObject(e)),this},parseWorksheetsDir:function(){return this.parseDir(config.EXCEL_FILES.DIR_WORKSHEETS)},setWorksheet:function(e,t){return this.file(config.EXCEL_FILES.DIR_WORKSHEETS+"/"+e,builder.buildObject(t)),this},setWorksheets:function(e){var t=this;return _.each(e,function(e){var r=e.name,i=e.data;t.setWorksheet(r,i)}),this},removeWorksheet:function(e){var t=config.EXCEL_FILES.DIR_WORKSHEETS+"/"+e,r=t+".rels";return this.file(t)?(this.remove(t),this.remove(r),this):this},parseWorksheetRelsDir:function(){return this.parseDir(config.EXCEL_FILES.DIR_WORKSHEETS_RELS)},setTemplateSheetRel:function(){var e=this;return this.parseWorksheetRelsDir().then(function(t){return e.templateSheetRel=t?{Relationships:t[0].Relationships}:null,e})},setWorksheetRel:function(e,t){return this.file(config.EXCEL_FILES.DIR_WORKSHEETS_RELS+"/"+e+".rels",builder.buildObject(t)),this},setWorksheetRels:function(e){var t=this;if(!this.templateSheetRel)return this;var r=builder.buildObject(this.templateSheetRel);return _.each(e,function(e){t.file(config.EXCEL_FILES.DIR_WORKSHEETS_RELS+"/"+e+".rels",r)}),this},parseFile:function(e){return parseString(this.file(e).asText())},parseDir:function(e){var t=this,r=this.folder(e).file(/.xml/),i=[];return r.reduce(function(e,r){return e.then(function(e){return parseString(t.file(r.name).asText()).then(function(e){return e.name=_.last(r.name.split("/")),i.push(e),i})})},Promise.resolve())},generateWithData:function(e){var t=this;return this.setTemplateSheetRel().then(function(){return t.setSharedStrings(e.sharedstrings.value()).setWorkbookRels(e.relationship.value()).setWorkbook(e.workbookxml.value()).setWorksheets(e.sheetXmls.value()).setWorksheetRels(e.sheetXmls.names()).generate({type:config.JSZIP_OPTION.BUFFER_TYPE_OUTPUT,compression:config.JSZIP_OPTION.COMPLESSION})})}}),module.exports=Excel;