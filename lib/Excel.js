"use strict";var Excel=require("jszip"),Promise=require("bluebird"),xml2js=require("xml2js"),parseString=Promise.promisify(xml2js.parseString),_=require("underscore");require("./underscore_mixin");var config={FILE_SHARED_STRINGS:"xl/sharedStrings.xml",FILE_WORKBOOK_RELS:"xl/_rels/workbook.xml.rels",FILE_WORKBOOK:"xl/workbook.xml",DIR_WORKSHEETS:"xl/worksheets",DIR_WORKSHEETS_RELS:"xl/worksheets/_rels"};_.extend(Excel.prototype,{sharedStrings:function(){return this.file(config.FILE_SHARED_STRINGS).asText()},parseSharedStrings:function(){return this.parseFile(config.FILE_SHARED_STRINGS)},hasAsSharedString:function(e){return-1!==this.sharedStrings().indexOf(e)},setSharedStrings:function(e){this.file(config.FILE_SHARED_STRINGS,_.xml(e))},parseWorkbookRels:function(){return this.parseFile(config.FILE_WORKBOOK_RELS)},setWorkbookRels:function(e){this.file(config.FILE_WORKBOOK_RELS,_.xml(e))},parseWorkbook:function(){return this.parseFile(config.FILE_WORKBOOK)},setWorkbook:function(e){this.file(config.FILE_WORKBOOK,_.xml(e))},parseWorksheetsDir:function(){return this.parseDir(config.DIR_WORKSHEETS)},setWorksheet:function(e,r){this.file(config.DIR_WORKSHEETS+"/"+e,_.xml(r))},setWorksheets:function(e){var r=this;_.each(e,function(e){var i=e.name,s=e.data;r.setWorksheet(i,s)})},removeWorksheet:function(e){this.remove(config.DIR_WORKSHEETS+"/"+e)},parseWorksheetRelsDir:function(){return this.parseDir(config.DIR_WORKSHEETS_RELS)},setWorksheetRel:function(e,r){this.file(config.DIR_WORKSHEETS_RELS+"/"+e+".rels",_.xml(r))},removeWorksheetRel:function(e){this.remove(config.DIR_WORKSHEETS_RELS+"/"+e+".rels")},parseFile:function(e){return parseString(this.file(e).asText())},parseDir:function(e){var r=this,i=this.folder(e).file(/.xml/),s=[];return i.reduce(function(e,i){return e.then(function(e){return parseString(r.file(i.name).asText()).then(function(e){return e.name=_.last(i.name.split("/")),s.push(e),s})})},Promise.resolve())}}),module.exports=Excel;