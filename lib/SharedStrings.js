"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_=require("underscore");require("./underscore_mixin");var Mustache=require("mustache"),SharedStrings=function(){function e(t,r){_classCallCheck(this,e),this.rawObj=t,this.templateSheetData=r,this.stringModels=this.parseStringModels()}return _createClass(e,[{key:"parseStringModels",value:function(){var t=this;if(!this.rawObj.sst.si)return null;var r=_.deepCopy(this.rawObj.sst.si);return _.each(this.filterStaticString(r),function(r){r.usingCells=_.reduce(t.templateSheetData,function(t,n){return t.concat(e.usingCellAddresses(n.c,r.sharedIndex))},[])}),r}},{key:"add",value:function(e){var t=this.stringModels.length;return _.each(e,function(e,r){e.sharedIndex=t+r}),this.stringModels=this.stringModels.concat(e),e}},{key:"value",value:function(){return this.stringModels?(this.rawObj.sst.si=_.deleteProperties(this.stringModels,["sharedIndex","usingCells"]),this.rawObj.sst.$.uniqueCount=this.stringModels.length,this.rawObj.sst.$.count=this.stringModels.length,this.rawObj):null}},{key:"filterStaticString",value:function(e){var t=[];return _.each(e,function(e,r){_.stringValue(e.t)&&_.hasVariable(_.stringValue(e.t))&&(e.sharedIndex=r,t.push(e))}),t}},{key:"hasString",value:function(){return!!this.stringModels}},{key:"buildNewSharedStrings",value:function(e){return _.reduce(_.deepCopy(this.filterStaticString(this.stringModels)),function(t,r){return r.t[0]=Mustache.render(_.stringValue(r.t),e),t.push(r),t},[])}},{key:"addMergedStrings",value:function(e){return this.hasString()?this.add(this.buildNewSharedStrings(e)):void 0}}],[{key:"usingCellAddresses",value:function(e,t){return _.reduce(e,function(e,r){return"s"===r.$.t&&t===r.v[0]>>0&&e.push(r.$.r),e},[])}}]),e}();module.exports=SharedStrings;