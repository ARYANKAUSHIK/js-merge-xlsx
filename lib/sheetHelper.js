"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var s=t[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,r,s){return r&&e(t.prototype,r),s&&e(t,s),t}}(),Mustache=require("mustache"),Promise=require("bluebird"),_=require("underscore");require("./underscore_mixin");var JSZip=require("jszip"),isNode=require("detect-node"),outputBuffer={type:isNode?"nodebuffer":"blob",compression:"DEFLATE"},jszipBuffer={type:isNode?"nodebuffer":"arraybuffer",compression:"DEFLATE"},xml2js=require("xml2js"),parseString=Promise.promisify(xml2js.parseString),builder=new xml2js.Builder,OPEN_XML_SCHEMA_DEFINITION="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet",SheetHelper=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"load",value:function(e){var t=this;return e instanceof JSZip?(this.excel=e,this.variables=_.variables(e.file("xl/sharedStrings.xml").asText()),this.commonStringsWithVariable=[],Promise.props({sharedstringsObj:parseString(e.file("xl/sharedStrings.xml").asText()),workbookxmlRels:parseString(this.excel.file("xl/_rels/workbook.xml.rels").asText()),workbookxml:parseString(this.excel.file("xl/workbook.xml").asText()),sheetXmls:this._parseDirInExcel("xl/worksheets"),sheetXmlsRels:this._parseDirInExcel("xl/worksheets/_rels")}).then(function(e){var r=e.sharedstringsObj,s=e.workbookxmlRels,i=e.workbookxml,n=e.sheetXmls,a=e.sheetXmlsRels;return t.sharedstrings=r.sst.si,t.workbookxmlRels=s,t.workbookxml=i,t.sheetXmls=n,t.sheetXmlsRels=a,t.templateSheetName=t.workbookxml.workbook.sheets[0].sheet[0].$.name,t.templateSheetData=_.find(n,function(e){return-1===e.name.indexOf(".rels")}).worksheet.sheetData[0].row,t.templateSheetRelsData=_.deepCopy(t._templateSheetRels()),t.commonStringsWithVariable=t._parseCommonStringWithVariable(),t})):Promise.reject("First parameter must be JSZip instance including MS-Excel data")}},{key:"simpleMerge",value:function(e){var t=this;if(!e)throw new Error("simpleMerge() must has parameter");return Promise.resolve().then(function(){return t._simpleMerge(e,outputBuffer)})}},{key:"bulkMergeMultiFile",value:function(e){var t=this;if(!_.isArray(e))throw new Error("bulkMergeMultiFile() has only array object");if(_.find(e,function(e){return!(e.name&&e.data)}))throw new Error("bulkMergeMultiFile() is called with invalid parameter");var r=new JSZip;return _.each(e,function(e){var s=e.name,i=e.data;return r.file(s,t._simpleMerge(i,jszipBuffer))}),Promise.resolve().then(function(){return r.generate(outputBuffer)})}},{key:"addSheetBindingData",value:function(e,t){var r=this;if(!e||!t)throw new Error("addSheetBindingData() needs to have 2 paramter.");var s=this._availableSheetid();this.workbookxmlRels.Relationships.Relationship.push({$:{Id:s,Type:OPEN_XML_SCHEMA_DEFINITION,Target:"worksheets/sheet"+s+".xml"}}),this.workbookxml.workbook.sheets[0].sheet.push({$:{name:e,sheetId:s.replace("rId",""),"r:id":s}});var i=void 0;this.sharedstrings&&!function(){i=_.deepCopy(r.commonStringsWithVariable),_.each(i,function(e){return e.t[0]=Mustache.render(_.stringValue(e.t),t)});var e=r.sharedstrings.length;_.each(i,function(t,s){t.sharedIndex=e+s,r.sharedstrings.push(t)})}();var n=this._sheetByName(this.templateSheetName).value,a=this._buildNewSheet(n,i);return a.name="sheet"+s+".xml",this.sheetXmls.push(a),this}},{key:"hasSheet",value:function(e){return!!this._sheetByName(e)}},{key:"focusOnFirstSheet",value:function(){var e=this._sheetByName(this._firstSheetName());return _.each(this.sheet_xmls,function(t){t.worksheet&&(t.worksheet.sheetViews[0].sheetView[0].$.tabSelected=t.name===e.value.worksheet.name?"1":"0")}),this}},{key:"isFocused",value:function(e){if(!e)throw new Error("isFocused() needs to have 1 paramter.");if(!this.hasSheet(e))throw new Error("Invalid sheet name '"+e+"'.");var t=this._sheetByName(e);return"1"===t.value.worksheet.sheetViews[0].sheetView[0].$.tabSelected}},{key:"deleteSheet",value:function(e){var t=this;if(!e)throw new Error("deleteSheet() needs to have 1 paramter.");var r=this._sheetByName(e);if(!r)throw new Error("Invalid sheet name '"+e+"'.");return _.each(this.workbookxmlRels.Relationships.Relationship,function(e,s){e&&e.$.Target===r.path&&t.workbookxmlRels.Relationships.Relationship.splice(s,1)}),_.each(this.workbookxml.workbook.sheets[0].sheet,function(r,s){r&&r.$.name===e&&t.workbookxml.workbook.sheets[0].sheet.splice(s,1)}),_.each(this.sheetXmls,function(e,s){e&&e.name===r.value.name&&(t.sheetXmls.splice(s,1),t.excel.remove("xl/worksheets/"+r.value.name),t.excel.remove("xl/worksheets/_rels/"+r.value.name+".rels"))}),this}},{key:"deleteTemplateSheet",value:function(){return this.deleteSheet(this.templateSheetName)}},{key:"hasAsSharedString",value:function(e){return-1!==this.excel.file("xl/sharedStrings.xml").asText().indexOf(e)}},{key:"templateVariables",value:function(){return this.variables}},{key:"generate",value:function(e){var t=this;return parseString(this.excel.file("xl/sharedStrings.xml").asText()).then(function(r){return t.sharedstrings&&(r.sst.si=_.deleteProperties(t.sharedstrings,["sharedIndex","usingCells"]),r.sst.$.uniqueCount=t.sharedstrings.length,r.sst.$.count=t._stringCount(),t.excel.file("xl/sharedStrings.xml",_.decode(builder.buildObject(r)))),t.excel.file("xl/_rels/workbook.xml.rels",_.decode(builder.buildObject(t.workbookxmlRels))),t.excel.file("xl/workbook.xml",_.decode(builder.buildObject(t.workbookxml))),_.each(t.sheetXmls,function(e){if(e.name){var r={};r.worksheet={},_.extend(r.worksheet,e.worksheet),t.excel.file("xl/worksheets/"+e.name,_.decode(builder.buildObject(r)))}}),t.templateSheetRelsData.value&&t.templateSheetRelsData.value.Relationships&&!function(){var e=_.decode(builder.buildObject({Relationships:t.templateSheetRelsData.value.Relationships}));_.each(t.sheetXmls,function(r){r.name&&t.excel.file("xl/worksheets/_rels/"+r.name+".rels",e)})}(),t.excel.generate(e)})}},{key:"_simpleMerge",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?outputBuffer:arguments[1];return new JSZip(this.excel.generate(jszipBuffer)).file("xl/sharedStrings.xml",Mustache.render(this.excel.file("xl/sharedStrings.xml").asText(),e)).generate(t)}},{key:"_parseCommonStringWithVariable",value:function(){var e=this,t=[];return _.each(this.sharedstrings,function(e,r){_.stringValue(e.t)&&_.hasVariable(_.stringValue(e.t))&&(e.sharedIndex=r,t.push(e))}),_.each(t,function(t){t.usingCells=[],_.each(e.templateSheetData,function(e){_.each(e.c,function(e){"s"===e.$.t&&t.sharedIndex===e.v[0]>>0&&t.usingCells.push(e.$.r)})})}),t}},{key:"_parseDirInExcel",value:function(e){var t=this,r=this.excel.folder(e).file(/.xml/),s=[];return r.reduce(function(e,r){return e.then(function(e){return Promise.resolve().then(function(){return parseString(t.excel.file(r.name).asText())}).then(function(e){return e.name=_.last(r.name.split("/")),s.push(e),s})})},Promise.resolve())}},{key:"_buildNewSheet",value:function(e,t){var r=_.deepCopy(e);return r.worksheet.sheetViews[0].sheetView[0].$.tabSelected="0",t?(_.each(t,function(e,t){_.each(e.usingCells,function(t){_.each(r.worksheet.sheetData[0].row,function(r){_.each(r.c,function(r){r.$.r===t&&(r.v[0]=e.sharedIndex)})})})}),r):r}},{key:"_availableSheetid",value:function(){var e=_.max(this.workbookxmlRels.Relationships.Relationship,function(e){return Number(e.$.Id.replace("rId",""))}),t="rId"+("00"+((e.$.Id.replace("rId","")>>0)+1)).slice(-3);return t}},{key:"_sheetByName",value:function(e){var t=_.find(this.workbookxml.workbook.sheets[0].sheet,function(t){return t.$.name===e});if(!t)return null;var r=t.$["r:id"],s=_.max(this.workbookxmlRels.Relationships.Relationship,function(e){return e.$.Id===r}).$.Target,i=_.last(s.split("/"));return{path:s,value:_.find(this.sheetXmls,function(e){return e.name===i})}}},{key:"_sheetRelsByName",value:function(e){var t=this._sheetByName(e).path,r=_.last(t.split("/"))+".rels";return{name:r,value:_.find(this.sheetXmlsRels,function(e){return e.name===r})}}},{key:"_templateSheetRels",value:function(){return this._sheetRelsByName(this.templateSheetName)}},{key:"_firstSheetName",value:function(){return this.workbookxml.workbook.sheets[0].sheet[0].$.name}},{key:"_stringCount",value:function(){var e=0;return _.each(this.sheetXmls,function(t){t.worksheet&&_.each(t.worksheet.sheetData[0].row,function(t){_.each(t.c,function(t){t.$.t&&e++})})}),e}}]),e}();module.exports=SheetHelper;