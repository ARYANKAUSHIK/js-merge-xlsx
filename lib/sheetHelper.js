"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var s=t[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,r,s){return r&&e(t.prototype,r),s&&e(t,s),t}}(),Mustache=require("mustache"),Promise=require("bluebird"),_=require("underscore");require("./underscore_mixin");var Excel=require("./Excel"),WorkBookXml=require("./WorkBookXml"),WorkBookRels=require("./WorkBookRels"),SheetXmls=require("./SheetXmls"),SharedStrings=require("./SharedStrings"),isNode=require("detect-node"),outputBuffer={type:isNode?"nodebuffer":"blob",compression:"DEFLATE"},jszipBuffer={type:isNode?"nodebuffer":"arraybuffer",compression:"DEFLATE"},SheetHelper=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"load",value:function(e){var t=this;return this.excel=e,this.commonStringsWithVariable=[],Promise.props({sharedstrings:e.parseSharedStrings(),workbookxmlRels:e.parseWorkbookRels(),workbookxml:e.parseWorkbook(),sheetXmls:e.parseWorksheetsDir(),templateSheetRel:e.templateSheetRel()}).then(function(e){var r=e.sharedstrings,s=e.workbookxmlRels,a=e.workbookxml,i=e.sheetXmls,n=e.templateSheetRel;return t.sharedstrings=new SharedStrings(r),t.relationship=new WorkBookRels(s),t.workbookxml=new WorkBookXml(a),t.sheetXmls=new SheetXmls(i),t.templateSheetRel=n,t.templateSheetData=_.find(i,function(e){return-1===e.name.indexOf(".rels")}).worksheet.sheetData[0].row,t.commonStringsWithVariable=t.parseCommonStringWithVariable(),t})}},{key:"simpleMerge",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?outputBuffer:arguments[1];return Excel.instanceOf(this.excel).merge(e).generate(t)}},{key:"bulkMergeMultiFile",value:function(e){var t=this;return _.reduce(e,function(e,r){var s=r.name,a=r.data;return e.file(s,t.simpleMerge(a,jszipBuffer)),e},new Excel).generate(outputBuffer)}},{key:"bulkMergeMultiSheet",value:function(e){var t=this;return _.each(e,function(e){var r=e.name,s=e.data;return t.addSheetBindingData(r,s)}),this.generate(outputBuffer)}},{key:"generate",value:function(e){return this.deleteTemplateSheet(),this.excel.setSharedStrings(this.sharedstrings.value()).setWorkbookRels(this.relationship.value()).setWorkbook(this.workbookxml.value()).setWorksheets(this.sheetXmls.value()).setWorksheetRels(this.sheetXmls.names(),this.templateSheetRel).generate(e)}},{key:"addSheetBindingData",value:function(e,t){var r=this.relationship.nextRelationshipId();this.relationship.add(r),this.workbookxml.add(e,r);var s=void 0;this.sharedstrings.hasString()&&(s=_.deepCopy(this.commonStringsWithVariable),_.each(s,function(e){return e.t[0]=Mustache.render(_.stringValue(e.t),t)}),this.sharedstrings.add(s));var a=this.findSheetByName(this.workbookxml.firstSheetName()).value,i=this.buildNewSheet(a,s);return i.name="sheet"+r+".xml",this.sheetXmls.add(i),this}},{key:"deleteTemplateSheet",value:function(){var e=this,t=this.workbookxml.firstSheetName(),r=this.findSheetByName(t);this.relationship["delete"](r.path),this.workbookxml["delete"](t),_.each(this.sheetXmls.value(),function(t){var s=t.name;t.data;s===r.value.name&&(e.excel.removeWorksheet(r.value.name),e.excel.removeWorksheetRel(r.value.name))}),this.sheetXmls["delete"](r.value.name)}},{key:"parseCommonStringWithVariable",value:function(){var e=this,t=this.sharedstrings.filterWithVariable();return _.each(t,function(t){t.usingCells=[],_.each(e.templateSheetData,function(e){_.each(e.c,function(e){"s"===e.$.t&&t.sharedIndex===e.v[0]>>0&&t.usingCells.push(e.$.r)})})}),t}},{key:"buildNewSheet",value:function(e,t){var r=_.deepCopy(e);return r.worksheet.sheetViews[0].sheetView[0].$.tabSelected="0",t?(_.each(t,function(e,t){_.each(e.usingCells,function(t){_.each(r.worksheet.sheetData[0].row,function(r){_.each(r.c,function(r){r.$.r===t&&(r.v[0]=e.sharedIndex)})})})}),r):r}},{key:"findSheetByName",value:function(e){var t=this.workbookxml.findSheetId(e);if(!t)return null;var r=this.relationship.findSheetPath(t),s=_.last(r.split("/"));return{path:r,value:this.sheetXmls.find(s)}}}]),e}();module.exports=SheetHelper;