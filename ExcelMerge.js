"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var s=t[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,r,s){return r&&e(t.prototype,r),s&&e(t,s),t}}(),Promise=require("bluebird"),_=require("underscore");require("./lib/underscore_mixin");var Excel=require("./lib/Excel"),WorkBookXml=require("./lib/WorkBookXml"),WorkBookRels=require("./lib/WorkBookRels"),SheetXmls=require("./lib/SheetXmls"),SharedStrings=require("./lib/SharedStrings"),isNode=require("detect-node"),config={compression:"DEFLATE",buffer_type_output:isNode?"nodebuffer":"blob",buffer_type_jszip:isNode?"nodebuffer":"arraybuffer"},ExcelMerge=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"load",value:function(e){var t=this;return this.excel=e,e.setTemplateSheetRel().then(function(){return Promise.props({sharedstrings:e.parseSharedStrings(),workbookxmlRels:e.parseWorkbookRels(),workbookxml:e.parseWorkbook(),sheetXmls:e.parseWorksheetsDir()})}).then(function(e){var r=e.sharedstrings,s=e.workbookxmlRels,i=e.workbookxml,o=e.sheetXmls;return t.relationship=new WorkBookRels(s),t.workbookxml=new WorkBookXml(i),t.sheetXmls=new SheetXmls(o),t.sharedstrings=new SharedStrings(r,t.sheetXmls.templateSheetData()),t})}},{key:"merge",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?{type:config.buffer_type_output,compression:config.compression}:arguments[1];return Excel.instanceOf(this.excel).merge(e).generate(t)}},{key:"bulkMergeMultiFile",value:function(e){var t=this;return _.reduce(e,function(e,r){var s=r.name,i=r.data;return e.file(s,t.merge(i,{type:config.buffer_type_jszip,compression:config.compression})),e},new Excel).generate({type:config.buffer_type_output,compression:config.compression})}},{key:"bulkMergeMultiSheet",value:function(e){return _.reduce(e,function(e,t){var r=t.name,s=t.data;return e.addSheetBindingData(r,s)},this).deleteTemplateSheet().generate({type:config.buffer_type_output,compression:config.compression})}},{key:"generate",value:function(e){return this.excel.setSharedStrings(this.sharedstrings.value()).setWorkbookRels(this.relationship.value()).setWorkbook(this.workbookxml.value()).setWorksheets(this.sheetXmls.value()).setWorksheetRels(this.sheetXmls.names()).generate(e)}},{key:"addSheetBindingData",value:function(e,t){var r=this.relationship.nextRelationshipId();this.relationship.add(r),this.workbookxml.add(e,r);var s=this.sharedstrings.addMergedStrings(t),i=this.findSheetByName(this.workbookxml.firstSheetName()).value,o=this.buildNewSheet(i,s);return this.sheetXmls.add(r,o),this}},{key:"deleteTemplateSheet",value:function(){var e=this.workbookxml.firstSheetName(),t=this.findSheetByName(e);return this.relationship["delete"](t.path),this.workbookxml["delete"](e),this.sheetXmls["delete"](t.value.name),this.excel.removeWorksheet(t.value.name),this}},{key:"buildNewSheet",value:function(e,t){var r=_.deepCopy(e.value());return r.worksheet.sheetViews[0].sheetView[0].$.tabSelected="0",this.setCellIndexes(r,t),r}},{key:"setCellIndexes",value:function(e,t){_.each(t,function(t){_.each(t.usingCells,function(r){_.each(e.worksheet.sheetData[0].row,function(e){_.each(e.c,function(e){e.$.r===r&&(e.v[0]=t.sharedIndex)})})})})}},{key:"findSheetByName",value:function(e){var t=this.workbookxml.findSheetId(e);if(!t)return null;var r=this.relationship.findSheetPath(t),s=_.last(r.split("/"));return{path:r,value:this.sheetXmls.find(s)}}},{key:"variables",value:function(){return this.excel.variables()}}]),e}();module.exports=ExcelMerge;