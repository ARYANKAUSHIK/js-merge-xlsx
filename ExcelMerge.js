"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),Promise=require("bluebird"),_=require("underscore");require("./lib/underscore_mixin");var Excel=require("./lib/Excel"),WorkBookXml=require("./lib/WorkBookXml"),WorkBookRels=require("./lib/WorkBookRels"),SheetXmls=require("./lib/SheetXmls"),SharedStrings=require("./lib/SharedStrings"),isNode=require("detect-node"),config={compression:"DEFLATE",buffer_type_output:isNode?"nodebuffer":"blob",buffer_type_jszip:isNode?"nodebuffer":"arraybuffer"},ExcelMerge=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"load",value:function(e){var t=this;return this.excel=e,e.setTemplateSheetRel().then(function(){return Promise.props({sharedstrings:e.parseSharedStrings(),workbookxmlRels:e.parseWorkbookRels(),workbookxml:e.parseWorkbook(),sheetXmls:e.parseWorksheetsDir()})}).then(function(e){var r=e.sharedstrings,i=e.workbookxmlRels,s=e.workbookxml,o=e.sheetXmls;return t.relationship=new WorkBookRels(i),t.workbookxml=new WorkBookXml(s),t.sheetXmls=new SheetXmls(o),t.sharedstrings=new SharedStrings(r,t.sheetXmls.templateSheetData()),t})}},{key:"merge",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?{type:config.buffer_type_output,compression:config.compression}:arguments[1];return Excel.instanceOf(this.excel).merge(e).generate(t)}},{key:"bulkMergeMultiFile",value:function(e){var t=this;return _.reduce(e,function(e,r){var i=r.name,s=r.data;return e.file(i,t.merge(s,{type:config.buffer_type_jszip,compression:config.compression})),e},new Excel).generate({type:config.buffer_type_output,compression:config.compression})}},{key:"bulkMergeMultiSheet",value:function(e){return _.reduce(e,function(e,t){var r=t.name,i=t.data;return e.addSheetBindingData(r,i)},this).deleteTemplateSheet().generate({type:config.buffer_type_output,compression:config.compression})}},{key:"generate",value:function(e){return this.excel.setSharedStrings(this.sharedstrings.value()).setWorkbookRels(this.relationship.value()).setWorkbook(this.workbookxml.value()).setWorksheets(this.sheetXmls.value()).setWorksheetRels(this.sheetXmls.names()).generate(e)}},{key:"addSheetBindingData",value:function(e,t){var r=this.relationship.nextRelationshipId();this.relationship.add(r),this.workbookxml.add(e,r);var i=this.sharedstrings.addMergedStrings(t),s=this.findSheetByName(this.workbookxml.firstSheetName()).value,o=s.cloneWithMergedString(i);return this.sheetXmls.add(r,o.value()),this}},{key:"deleteTemplateSheet",value:function(){var e=this.workbookxml.firstSheetName(),t=this.findSheetByName(e);return this.relationship["delete"](t.path),this.workbookxml["delete"](e),this.sheetXmls["delete"](t.value.name),this.excel.removeWorksheet(t.value.name),this}},{key:"buildNewSheet",value:function(e,t){return e.cloneWithMergedString(t)}},{key:"findSheetByName",value:function(e){var t=this.workbookxml.findSheetId(e);if(!t)return null;var r=this.relationship.findSheetPath(t),i=_.last(r.split("/"));return{path:r,value:this.sheetXmls.find(i)}}},{key:"variables",value:function(){return this.excel.variables()}}]),e}();module.exports=ExcelMerge;